# 配置驱动视图系统 — 技术方案总览

## 一、系统目标

通过一份 JSON 配置描述文档的结构、样式与嵌套关系，在运行时将配置解析为 Vue 视图，实现「配置即结构」、编辑与预览一体化的文档/内容展示系统。

## 二、整体架构

```
┌─────────────────┐     config (JSON)      ┌─────────────────┐
│  ConfigEditor   │ ──────────────────────►│  PreviewPanel   │
│  (左侧编辑)      │   reactive 双向绑定      │  (右侧预览)      │
└─────────────────┘                        └────────┬────────┘
                                                      │
                                                      ▼
                                             ┌─────────────────┐
                                             │ComponentRenderer│
                                             │ (type → 组件)   │
                                             └────────┬────────┘
                                                      │
                       ┌──────────────────────────────┼──────────────────────────────┐
                       ▼                              ▼                              ▼
                 Section/List/Table              Heading/Paragraph              Note/Image
                 (递归子 content)                 (叶子组件)                    (可嵌套 content)
```

- **单一数据源**：整棵视图树由根级 `config` 驱动。
- **组件映射**：`config.type` → `componentMap[type]` → 动态 `<component :is>`。
- **递归在容器内**：Section / List / Table / Note 等容器在内部 `v-for` 子项，每项用 `<component-renderer>` 渲染，避免 ComponentRenderer 与 componentMap 产生循环依赖。

## 三、配置结构约定

### 3.1 根级字段

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| version | string | 建议 | 文档版本，如 `"1.0.0"` |
| metadata | object | 否 | title、author、lastUpdated 等元信息 |
| styles | object | 否 | 全局 / 按类型 / 自定义样式定义 |
| content | array | 是 | 内容块数组，每项为块级配置 |

### 3.2 内容项通用字段

| 字段 | 说明 |
|------|------|
| type | 组件类型，对应 componentMap 的 key |
| style | 可选，引用 `styles.customStyles[style]` |
| inlineStyles | 可选，内联样式对象（驼峰键名） |

### 3.3 各 type 的配置形态

- **heading**：level（1–6）、content
- **paragraph**：content
- **list**：style（ordered/unordered）、items（字符串或带 type 的对象数组）
- **table**：headers、rows（单元格可为字符串或带 type 的对象）、columnAlignments 可选
- **section**：title 可选、content（子块数组）
- **note**：content（字符串或带 type 的对象）、icon 可选
- **image**：src 必填，alt/width/height/caption 可选
- **link**：href、content，target/rel 可选
- **richText**：content（HTML 字符串，会经 DOMPurify 净化）
- **styledText**：content
- **divider**：无额外必填字段

## 四、核心技术点

### 4.1 组件映射（componentMap.js）

- 文件：src/components/content/componentMap.js
- 做法：`type` 字符串 → Vue 组件 的映射表。
- 使用：ComponentRenderer 根据 `config.type` 取 `componentMap[config.type]`，用 `<component :is="comp">` 动态挂载对应组件；未命中则兜底显示「未知组件类型」。
- 扩展：新增 type 时在 componentMap 注册并实现对应组件即可。

### 4.2 递归渲染器（ComponentRenderer）

- 文件：src/components/content/ComponentRenderer.vue。
- 职责：接收单条 config 和全局 styles，解析出组件并传入 config、styles。
- 递归：不在此处递归，而是由「容器型」组件（Section、List、Table、Note 等）在内部再 v-for 子项并为每项渲染一个 `<component-renderer>`，从而形成树形渲染；叶子组件（如 Heading、Paragraph）不再渲染子块。
- **原因**：避免 ComponentRenderer 与 componentMap、容器组件之间的循环依赖；各容器子结构形态不一，由容器自身负责更清晰。

### 4.3 样式系统（useStyles）

- 文件：src/composables/useStyles.js
- 合并顺序（优先级从低到高）：
  - 按 config.type 的全局样式（如 styles.heading）
  - 按类型的子级样式（如 styles.heading['h1']，依赖 config.level）
  - 自定义样式名（config.style → styles.customStyles[config.style]）
  - 内联样式 config.inlineStyles
- 输出：`mergedStyles`（对象）、`cssStyles`（kebab 命名的 CSS 字符串），供组件 `:style="cssStyles"` 绑定。
- 约定：配置里用驼峰（如 fontSize），输出时用 kebabCase 转成 CSS 属性名。

### 4.4 配置校验（useConfigValidation）

- 文件：src/composables/useConfigValidation.js
- 时机：在 ConfigEditor 中，编辑/保存时对当前配置做校验。
- 内容：校验根级必含 content 数组；每项必含 type；按 type 校验必填字段；对 section 的 content 递归校验。
- 结果：errors（阻止保存）、warnings（如缺 version）仅提示。

### 4.5 配置的加载、解析与编辑

- 文件：src/utils/configParser.js
- 能力：loadConfig(filePath) 拉取 JSON；parseConfig(jsonString) 解析编辑器字符串；formatConfig(config) 序列化为带缩进的 JSON；getExampleConfigs() 返回示例列表；saveConfig 当前为占位（可接后端 API）。
- 与编辑器的配合：ConfigEditor 用 v-model 绑定 layout 的 config，通过 parseConfig/formatConfig 与 JSON 字符串互转，实现「左侧改 JSON → 右侧实时预览」。

### 4.6 版本控制（useVersionControl）

- 文件：src/composables/useVersionControl.js
- 做法：内存中维护 versionHistory，每项为 { version, timestamp, config }；saveVersion(config) 深拷贝当前 config 入栈并可选递增版本号；rollbackToVersion(version) 返回某版本的 config 深拷贝供恢复。
- 使用：EditorLayout 在加载示例、保存时调用 saveVersion，重置时用历史中的最新 config 覆盖当前 config。

### 4.7 容器型组件的递归与异构子项

- Section：config.content 为数组，逐项用 ComponentRenderer 渲染，支持折叠。
- List：config.items 中元素可为字符串或对象；对象时用 ComponentRenderer 渲染（实现列表项内嵌 note、段落等）。
- Table：headers 为字符串数组；rows 中单元格可为字符串或带 type 的对象（如 { type: 'image', src, alt }），对象时用 ComponentRenderer 渲染。
- Note：config.content 可为字符串或对象，对象时用 ComponentRenderer 渲染。
- 实现细节：通过 typeof item === 'object' && item.type（或类似）判断是否走 ComponentRenderer，保证同一套配置协议在任意层级复用。

## 五、目录与文档索引

| 类别 | 文档 | 说明 |
|------|------|------|
| 总览 | [00-技术方案总览.md](./00-技术方案总览.md) | 本文档 |
| 设计说明 | [01-为什么递归在容器组件而非ComponentRenderer.md](./01-为什么递归在容器组件而非ComponentRenderer.md) | 递归职责与容器设计 |
| 递归与树形问答 | [02-递归与树形设计问答.md](./02-递归与树形设计问答.md) | 自递归、Vue 递归、JSON 树形约定等问答 |
| 内容渲染 | [ComponentRenderer](./components/ComponentRenderer.md) | 根据 type 分发组件 |
| 组件映射 | [componentMap](./components/componentMap.md) | type → 组件映射表 |
| 内容组件 | [Heading](./components/HeadingComponent.md) [Paragraph](./components/ParagraphComponent.md) [List](./components/ListComponent.md) [Table](./components/TableComponent.md) [Section](./components/SectionComponent.md) [Note](./components/NoteComponent.md) [StyledText](./components/StyledTextComponent.md) [RichText](./components/RichTextComponent.md) [Image](./components/ImageComponent.md) [Link](./components/LinkComponent.md) [Divider](./components/DividerComponent.md) | 各 type 对应组件 |
| 通用组件 | [ConfigEditor](./components/ConfigEditor.md) [PreviewPanel](./components/PreviewPanel.md) [VersionControl](./components/VersionControl.md) | 编辑、预览、版本 UI |
| 布局 | [EditorLayout](./components/EditorLayout.md) | 编辑+预览布局 |
| 组合式 | [useStyles](./components/useStyles.md) [useConfigValidation](./components/useConfigValidation.md) [useVersionControl](./components/useVersionControl.md) | 样式、校验、版本逻辑 |
| 工具 | [configParser](./components/configParser.md) | 配置加载与解析 |
