# 配置驱动视图系统 — 技术方案总览

## 一、系统目标

通过一份 JSON 配置描述文档的结构、样式与嵌套关系，在运行时将配置解析为 Vue 视图，实现「配置即结构」、编辑与预览一体化的文档/内容展示系统。

## 二、整体架构

```
┌─────────────────┐     config (JSON)      ┌─────────────────┐
│  ConfigEditor   │ ──────────────────────►│  PreviewPanel   │
│  (左侧编辑)      │   reactive 双向绑定      │  (右侧预览)      │
└─────────────────┘                        └────────┬────────┘
                                                      │
                                                      ▼
                                             ┌─────────────────┐
                                             │ComponentRenderer│
                                             │ (type → 组件)   │
                                             └────────┬────────┘
                                                      │
                       ┌──────────────────────────────┼──────────────────────────────┐
                       ▼                              ▼                              ▼
                 Section/List/Table              Heading/Paragraph              Note/Image
                 (递归子 content)                 (叶子组件)                    (可嵌套 content)
```

- **单一数据源**：整棵视图树由根级 `config` 驱动。
- **组件映射**：`config.type` → `componentMap[type]` → 动态 `<component :is>`。
- **递归在容器内**：Section / List / Table / Note 等容器在内部 `v-for` 子项，每项用 `<component-renderer>` 渲染，避免 ComponentRenderer 与 componentMap 产生循环依赖。

## 三、配置结构约定

### 3.1 根级字段

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| version | string | 建议 | 文档版本，如 `"1.0.0"` |
| metadata | object | 否 | title、author、lastUpdated 等元信息 |
| styles | object | 否 | 全局 / 按类型 / 自定义样式定义 |
| content | array | 是 | 内容块数组，每项为块级配置 |

### 3.2 内容项通用字段

| 字段 | 说明 |
|------|------|
| type | 组件类型，对应 componentMap 的 key |
| style | 可选，引用 `styles.customStyles[style]` |
| inlineStyles | 可选，内联样式对象（驼峰键名） |

### 3.3 各 type 的配置形态

- **heading**：level（1–6）、content
- **paragraph**：content
- **list**：style（ordered/unordered）、items（字符串或带 type 的对象数组）
- **table**：headers、rows（单元格可为字符串或带 type 的对象）、columnAlignments 可选
- **section**：title 可选、content（子块数组）
- **note**：content（字符串或带 type 的对象）、icon 可选
- **image**：src 必填，alt/width/height/caption 可选
- **link**：href、content，target/rel 可选
- **richText**：content（HTML 字符串，会经 DOMPurify 净化）
- **styledText**：content
- **divider**：无额外必填字段

## 四、核心技术点

### 4.1 组件映射（componentMap.js）

- `type` 字符串 → Vue 组件的映射表。
- ComponentRenderer 根据 `config.type` 取 `componentMap[config.type]`，用 `<component :is="comp">` 挂载。
- 扩展：新增 type 时在 componentMap 注册并实现对应组件即可。

### 4.2 递归渲染（职责分离）

- **ComponentRenderer**：只做「单节点 → 选组件 → 传 config/styles」，不遍历子节点。
- **容器组件**：在各自模板中 `v-for` 自己的子数据（content/items/rows 等），在循环内使用 `<component-renderer>`，形成树形渲染；子节点包裹结构（如 `<li>`、`<td>`）由容器决定。
- **原因**：避免 ComponentRenderer 与 componentMap、容器组件之间的循环依赖；各容器子结构形态不一，由容器自身负责更清晰。

### 4.3 样式系统（useStyles）

- 合并顺序（优先级从低到高）：类型基础样式 → 类型子级（如 heading.h1）→ customStyles[config.style] → config.inlineStyles。
- 输出：`mergedStyles`（对象）、`cssStyles`（kebab 命名的 CSS 字符串），供组件 `:style="cssStyles"` 绑定。
- 配置侧使用驼峰，useStyles 内通过 kebabCase 转为 CSS 属性名。

### 4.4 配置校验（useConfigValidation）

- 校验根级必含 content 数组；每项必含 type；按 type 校验必填字段；对 section 的 content 递归校验。
- 结果：errors（阻止保存）、warnings（如缺 version）仅提示。

### 4.5 配置 I/O（configParser）

- loadConfig、parseConfig、formatConfig、getExampleConfigs；saveConfig 为占位可接后端。

### 4.6 版本控制（useVersionControl）

- 内存中维护 versionHistory，每项为 { version, timestamp, config }；saveVersion 深拷贝入栈，rollbackToVersion 返回某版本 config 深拷贝。

### 4.7 循环依赖与异步组件

- 容器组件（Section、List、Table、Note）通过 `defineAsyncComponent(() => import('./ComponentRenderer.vue'))` 引用 ComponentRenderer，避免与 componentMap 的同步引用形成循环依赖。

## 五、目录与文档索引

| 类别 | 文档 | 说明 |
|------|------|------|
| 总览 | [00-技术方案总览.md](./00-技术方案总览.md) | 本文档 |
| 内容渲染 | [ComponentRenderer](./components/ComponentRenderer.md) | 根据 type 分发组件 |
| 组件映射 | [componentMap](./components/componentMap.md) | type → 组件映射表 |
| 内容组件 | [Heading](./components/HeadingComponent.md) [Paragraph](./components/ParagraphComponent.md) [List](./components/ListComponent.md) [Table](./components/TableComponent.md) [Section](./components/SectionComponent.md) [Note](./components/NoteComponent.md) [StyledText](./components/StyledTextComponent.md) [RichText](./components/RichTextComponent.md) [Image](./components/ImageComponent.md) [Link](./components/LinkComponent.md) [Divider](./components/DividerComponent.md) | 各 type 对应组件 |
| 通用组件 | [ConfigEditor](./components/ConfigEditor.md) [PreviewPanel](./components/PreviewPanel.md) [VersionControl](./components/VersionControl.md) | 编辑、预览、版本 UI |
| 布局 | [EditorLayout](./components/EditorLayout.md) | 编辑+预览布局 |
| 组合式 | [useStyles](./components/useStyles.md) [useConfigValidation](./components/useConfigValidation.md) [useVersionControl](./components/useVersionControl.md) | 样式、校验、版本逻辑 |
| 工具 | [configParser](./components/configParser.md) | 配置加载与解析 |
